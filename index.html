<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyHome RENT Proposal Compiler Assistant</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
    }
    #paramContainer {
      display: none;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
    }
    tr:hover {
      background-color: #eef;
      cursor: pointer;
    }
    input {
      width: 100%;
      padding: 5px;
      font-size: 14px;
    }
    #status {
      margin-top: 10px;
      font-size: 13px;
      color: #c00;
    }
  </style>
</head>
<body>

  <h3>Clicca per cercare un parametro...</h3>
  <input type="text" id="searchInput" placeholder="Cerca..." />
  <div id="paramContainer">
    <table id="paramTable">
      <thead>
        <tr>
          <th>Parametro</th>
          <th>Categoria</th>
          <th>Descrizione</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="status"></div>

  <script>
    const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1KJ7kIyv2Px87iRXLs8meNHI-bdVvWu9gcMLgHoQnSorvjkRM7lqSsj2lgl2nU0Ge1BFEogX1Yi1j/pub?output=csv";
    let parametri = [];

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    async function loadCSVParams() {
      try {
        const response = await fetch(csvURL);
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const params = lines.slice(1)
          .map(line => line.split(','))
          .filter(values => values.length >= 3)
          .map(values => ({
            valore: values[0].trim(),
            categoria: values[1].trim(),
            descrizione: values[2].trim()
          }));
        return params;
      } catch (e) {
        console.error("Errore nel caricamento CSV:", e);
        setStatus("❌ Errore nel caricamento dei parametri.");
        return [];
      }
    }

    function renderTable(data) {
      const tbody = document.querySelector("#paramTable tbody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 3;
        cell.textContent = "Nessun parametro trovato.";
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      data.forEach(p => {
        const row = document.createElement("tr");
        row.addEventListener("click", () => insertParam(p.valore));
        row.innerHTML = `<td>${p.valore}</td><td>${p.categoria}</td><td>${p.descrizione}</td>`;
        tbody.appendChild(row);
      });
    }

    function setupSearch() {
      const input = document.getElementById("searchInput");
      const container = document.getElementById("paramContainer");
      input.addEventListener("focus", () => {
        container.style.display = "block";
      });
      input.addEventListener("input", () => {
        const query = input.value.toLowerCase();
        const filtered = parametri.filter(p =>
          p.valore.toLowerCase().includes(query) ||
          p.categoria.toLowerCase().includes(query) ||
          p.descrizione.toLowerCase().includes(query)
        );
        renderTable(filtered);
      });
    }

    function insertParam(param) {
      try {
        Word.run(async (context) => {
          const range = context.document.getSelection();
          range.insertText(param, Word.InsertLocation.replace);
          await context.sync();
          setStatus("✅ Parametro inserito.");
        }).catch(error => {
          console.error("Errore Word.run:", error);
          setStatus("❌ Errore durante l'inserimento. Verifica di aver selezionato un punto nel documento.");
        });
      } catch (e) {
        console.error("Errore globale insertParam:", e);
        setStatus("❌ Errore generale durante l'inserimento.");
      }
    }

    Office.onReady(() => {
      (async function init() {
        parametri = await loadCSVParams();
        renderTable(parametri);
        setupSearch();
        setStatus("🔎 Ricerca pronta. Seleziona un parametro.");
      })();
    });
  </script>

</body>
</html>
